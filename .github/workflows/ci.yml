name: CI Validation

on:
  pull_request:
    branches:
      - main
  push:
    branches-ignore:
      - main

env:
  NODE_VERSION: '20.x'

jobs:
  # Validate OpenAPI specification
  validate-openapi:
    name: Validate OpenAPI Spec
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install validation tools
        run: |
          npm install -g @openapitools/openapi-generator-cli
          npm install -g @stoplight/spectral-cli

      - name: Validate OpenAPI spec
        run: |
          openapi-generator-cli validate -i specs/openapi.yaml
          echo "✅ OpenAPI spec is valid"

      - name: Lint OpenAPI spec with Spectral
        run: |
          spectral lint specs/openapi.yaml --ruleset https://raw.githubusercontent.com/stoplightio/spectral/master/packages/rulesets/src/oas/index.ts || echo "⚠️  Spectral warnings found"

  # Detect breaking changes in OpenAPI spec
  detect-breaking-changes:
    name: Detect Breaking Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install openapi-diff
        run: npm install -g openapi-diff

      - name: Get base OpenAPI spec
        run: |
          git show origin/main:specs/openapi.yaml > /tmp/openapi-base.yaml 2>/dev/null || echo "openapi: 3.0.0" > /tmp/openapi-base.yaml

      - name: Compare OpenAPI specs
        id: diff
        run: |
          if openapi-diff /tmp/openapi-base.yaml specs/openapi.yaml --json > /tmp/diff.json; then
            echo "breaking=false" >> $GITHUB_OUTPUT
            echo "✅ No breaking changes detected"
          else
            echo "breaking=true" >> $GITHUB_OUTPUT
            echo "⚠️  Breaking changes detected"
            cat /tmp/diff.json
          fi

      - name: Comment on PR with breaking changes
        if: steps.diff.outputs.breaking == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Breaking changes detected in OpenAPI spec**\n\nThis PR contains breaking changes to the API. This will trigger a **major** version bump.\n\nPlease review the changes carefully and update the CHANGELOG.md accordingly.'
            })

  # Validate liblab configuration
  validate-liblab-config:
    name: Validate liblab Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install liblab CLI
        run: npm install -g liblab

      - name: Validate liblab config
        run: |
          # liblab doesn't have a validate command, so we'll just check the file exists and is valid JSON
          if [ -f "liblab.config.json" ]; then
            node -e "JSON.parse(require('fs').readFileSync('liblab.config.json', 'utf8'))"
            echo "✅ liblab.config.json is valid"
          else
            echo "❌ liblab.config.json not found"
            exit 1
          fi

  # Test SDK generation
  test-sdk-generation:
    name: Test SDK Generation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install liblab CLI
        run: npm install -g liblab

      - name: Generate SDK
        env:
          LIBLAB_TOKEN: ${{ secrets.LIBLAB_API_KEY }}
        run: |
          liblab build --yes
          echo "✅ SDK generation successful"

      - name: Verify generated output
        run: |
          if [ -d "output/typescript" ]; then
            echo "✅ TypeScript SDK generated"
            ls -la output/typescript/
          else
            echo "❌ TypeScript SDK not generated"
            exit 1
          fi

  # Build and test packages
  build-packages:
    name: Build ${{ matrix.package }}
    runs-on: ubuntu-latest
    needs: test-sdk-generation
    strategy:
      matrix:
        package: [sdk, cli, mcp]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd packages/${{ matrix.package }}
          npm ci || npm install

      - name: Lint package
        run: |
          cd packages/${{ matrix.package }}
          npm run lint || echo "⚠️  Linting skipped (no lint script)"

      - name: Build package
        run: |
          cd packages/${{ matrix.package }}
          npm run build

      - name: Test package
        run: |
          cd packages/${{ matrix.package }}
          npm test --passWithNoTests || echo "⚠️  No tests found"

      - name: Check package
        run: |
          cd packages/${{ matrix.package }}
          npm pack --dry-run

  # Validate VERSION.yaml
  validate-version-file:
    name: Validate VERSION.yaml
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install js-yaml
        run: npm install -g js-yaml

      - name: Validate VERSION.yaml syntax
        run: |
          js-yaml VERSION.yaml > /dev/null
          echo "✅ VERSION.yaml is valid YAML"

      - name: Check version format
        run: |
          version=$(grep -oP '(?<=version: )[0-9]+\.[0-9]+\.[0-9]+' VERSION.yaml | head -1)
          if [[ $version =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "✅ Version format is valid: $version"
          else
            echo "❌ Invalid version format"
            exit 1
          fi

  # Summary job
  ci-success:
    name: CI Validation Complete
    runs-on: ubuntu-latest
    needs:
      - validate-openapi
      - detect-breaking-changes
      - validate-liblab-config
      - test-sdk-generation
      - build-packages
      - validate-version-file
    steps:
      - name: All checks passed
        run: |
          echo "✅ All CI validation checks passed"
          echo "This PR is ready for review and merge"
