name: Release Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'specs/openapi.yaml'
      - 'liblab.config.json'
      - '.github/workflows/release.yml'
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Version override (leave empty for auto-detection)'
        required: false
        type: string
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        type: boolean
        default: false

# Prevent race conditions: ensure only one workflow commits to main at a time
# This concurrency group is SHARED with mx-api-gateway/sync-and-release.yaml
# to prevent the sync workflow from pushing while release is running (and vice versa)
# See: https://github.com/memnexus-ai/mx-releases/issues/4
concurrency:
  group: mx-releases-commits
  cancel-in-progress: false

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 1: Read version from OpenAPI spec
  # Version is now managed upstream in mx-core-api and embedded in the synced spec
  determine-version:
    name: Read Version from Spec
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install js-yaml
        run: npm install -g js-yaml

      - name: Read version from OpenAPI spec
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version_override }}" ]; then
            # Manual override takes precedence
            VERSION="${{ github.event.inputs.version_override }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "‚úÖ Using manual version override: $VERSION"
          else
            # Extract version from OpenAPI spec info.version field
            VERSION=$(js-yaml specs/openapi.yaml | jq -r '.info.version')

            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              echo "‚ùå ERROR: Could not extract version from OpenAPI spec"
              exit 1
            fi

            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "üì¶ Version from OpenAPI spec: $VERSION"
            echo ""
            echo "‚ÑπÔ∏è  Version is managed upstream by mx-core-api auto-bump workflow"
            echo "‚ÑπÔ∏è  mx-releases simply reads and publishes the version from the spec"
          fi

  # Job 2: Generate SDKs using liblab (TypeScript and Python)
  generate-sdks:
    name: Generate SDKs
    runs-on: ubuntu-latest
    needs: determine-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install liblab CLI
        run: npm install -g liblab

      - name: Verify liblab installation
        run: liblab --version

      - name: Generate SDKs with liblab
        env:
          LIBLAB_TOKEN: ${{ secrets.LIBLAB_API_KEY }}
        run: |
          echo "Generating TypeScript and Python SDKs with liblab..."
          liblab build --yes
          echo "‚úÖ SDK generation complete"

      - name: Move generated TypeScript SDK to packages directory
        run: |
          rm -rf packages/typescript-sdk/*
          mkdir -p packages/typescript-sdk
          cp -r output/typescript/* packages/typescript-sdk/
          echo "‚úÖ TypeScript SDK moved to packages/typescript-sdk/"

      - name: Move generated Python SDK to packages directory
        run: |
          rm -rf packages/python-sdk/*
          mkdir -p packages/python-sdk
          cp -r output/python/* packages/python-sdk/
          echo "‚úÖ Python SDK moved to packages/python-sdk/"

      - name: Update TypeScript SDK version and fix package metadata
        run: |
          cd packages/typescript-sdk
          npm version ${{ needs.determine-version.outputs.version }} --no-git-tag-version
          # Fix package name to use scoped name
          npm pkg set name="@memnexus-ai/typescript-sdk"
          # Fix repository URL for npm provenance verification
          npm pkg set repository.type=git
          npm pkg set repository.url="https://github.com/memnexus-ai/mx-releases"
          npm pkg set repository.directory="packages/typescript-sdk"
          echo "‚úÖ TypeScript SDK version updated to ${{ needs.determine-version.outputs.version }}"
          echo "‚úÖ Package name fixed to @memnexus-ai/typescript-sdk"
          echo "‚úÖ Repository URL fixed for provenance"

      - name: Update Python SDK version
        run: |
          cd packages/python-sdk
          # Update version in pyproject.toml or setup.py
          if [ -f "pyproject.toml" ]; then
            sed -i "s/^version = .*/version = \"${{ needs.determine-version.outputs.version }}\"/" pyproject.toml
          fi
          if [ -f "setup.py" ]; then
            sed -i "s/version=.*/version=\"${{ needs.determine-version.outputs.version }}\",/" setup.py
          fi
          echo "‚úÖ Python SDK version updated to ${{ needs.determine-version.outputs.version }}"

      - name: Upload TypeScript SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: typescript-sdk-package
          path: packages/typescript-sdk/

      - name: Upload Python SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-sdk-package
          path: packages/python-sdk/

  # Job 3: Build and test TypeScript SDK
  build-typescript-sdk:
    name: Build & Test TypeScript SDK
    runs-on: ubuntu-latest
    needs: [determine-version, generate-sdks]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download TypeScript SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: typescript-sdk-package
          path: packages/typescript-sdk/

      - name: Install dependencies
        run: |
          cd packages/typescript-sdk
          npm ci || npm install

      - name: Build package
        run: |
          cd packages/typescript-sdk
          npm run build

      - name: Run tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          cd packages/typescript-sdk
          npm test --passWithNoTests || echo "No tests found, continuing..."

      - name: Check package contents
        run: |
          cd packages/typescript-sdk
          npm pack --dry-run

      - name: Upload built TypeScript SDK
        uses: actions/upload-artifact@v4
        with:
          name: typescript-sdk-built
          path: packages/typescript-sdk/

  # Job 3b: Build and test Python SDK
  # NOTE: Disabled until PyPI publishing is configured
  build-python-sdk:
    if: false  # Disabled - enable when PyPI is ready
    name: Build & Test Python SDK
    runs-on: ubuntu-latest
    needs: [determine-version, generate-sdks]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download Python SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: python-sdk-package
          path: packages/python-sdk/

      - name: Install build tools
        run: |
          pip install --upgrade pip build twine

      - name: Install dependencies
        run: |
          cd packages/python-sdk
          pip install -e . || pip install .

      - name: Build package
        run: |
          cd packages/python-sdk
          python -m build

      - name: Run tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          cd packages/python-sdk
          pip install pytest || true
          pytest --passWithNoTests || echo "No tests found, continuing..."

      - name: Check package contents
        run: |
          cd packages/python-sdk
          twine check dist/*

      - name: Upload built Python SDK
        uses: actions/upload-artifact@v4
        with:
          name: python-sdk-built
          path: packages/python-sdk/dist/

  # Job 4: Publish TypeScript SDK to @next (must happen before CLI/MCP can install it)
  publish-typescript-sdk:
    name: Publish TypeScript SDK to @next
    runs-on: ubuntu-latest
    needs: [determine-version, build-typescript-sdk]
    permissions:
      contents: read
      id-token: write
    outputs:
      version: ${{ needs.determine-version.outputs.version }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          scope: '@memnexus-ai'

      - name: Download TypeScript SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: typescript-sdk-built
          path: typescript-sdk-built/

      - name: Install dependencies
        run: |
          cd typescript-sdk-built
          npm ci || npm install

      - name: Check if TypeScript SDK version already published
        id: check-ts-sdk-published
        run: |
          VERSION=${{ needs.determine-version.outputs.version }}
          if npm view @memnexus-ai/typescript-sdk@${VERSION} version 2>/dev/null; then
            echo "TypeScript SDK version ${VERSION} already published, skipping publish"
            echo "already_published=true" >> $GITHUB_OUTPUT
          else
            echo "TypeScript SDK version ${VERSION} not found, will publish"
            echo "already_published=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish TypeScript SDK to @next
        if: steps.check-ts-sdk-published.outputs.already_published != 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
        run: |
          cd typescript-sdk-built
          # Use --ignore-scripts to skip prepublishOnly since we already built
          npm publish --tag next --access public --provenance --ignore-scripts
          echo "‚úÖ TypeScript SDK published to @next"

      - name: Verify TypeScript SDK published
        # This step is intentionally non-fatal (continue-on-error: true)
        # The publish step already succeeded - npm registry propagation delays
        # should not trigger a rollback that deprecates the package
        continue-on-error: true
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          echo "Waiting for npm registry to propagate version ${VERSION}..."

          # Retry up to 6 times (30 seconds total) for npm registry propagation
          for i in 1 2 3 4 5 6; do
            echo "Attempt $i/6: Checking npm registry..."
            if npm view @memnexus-ai/typescript-sdk@${VERSION} version 2>/dev/null; then
              echo "‚úÖ TypeScript SDK ${VERSION} verified on npm registry"
              exit 0
            fi
            echo "Not found yet, waiting 5 seconds..."
            sleep 5
          done

          echo "‚ö†Ô∏è Warning: Could not verify package on npm registry after 30 seconds"
          echo "This is likely a propagation delay - the package was published successfully"
          echo "Check manually: npm view @memnexus-ai/typescript-sdk@${VERSION}"
          # Exit 0 to not fail the job - the publish step already succeeded
          exit 0

  # Job 4b: Publish Python SDK to PyPI
  # NOTE: Disabled until PyPI publishing is configured
  publish-python-sdk:
    if: false  # Disabled - enable when PyPI is ready
    name: Publish Python SDK to PyPI
    runs-on: ubuntu-latest
    needs: [determine-version, build-python-sdk]
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install twine
        run: pip install --upgrade twine

      - name: Download Python SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: python-sdk-built
          path: python-sdk-built/

      - name: Check if Python SDK version already published
        id: check-py-sdk-published
        run: |
          VERSION=${{ needs.determine-version.outputs.version }}
          if pip index versions memnexus-python-sdk 2>/dev/null | grep -q "${VERSION}"; then
            echo "Python SDK version ${VERSION} already published, skipping publish"
            echo "already_published=true" >> $GITHUB_OUTPUT
          else
            echo "Python SDK version ${VERSION} not found, will publish"
            echo "already_published=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish Python SDK to PyPI
        if: steps.check-py-sdk-published.outputs.already_published != 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          cd python-sdk-built
          twine upload --non-interactive *.whl *.tar.gz || twine upload --non-interactive *
          echo "‚úÖ Python SDK published to PyPI"

      - name: Verify Python SDK published
        run: |
          sleep 10  # Give PyPI time to propagate
          pip index versions memnexus-python-sdk || echo "Note: pip index may take a few minutes to update"
          echo "‚úÖ Python SDK publish initiated"

  # Job 5: Build CLI and MCP (can now install SDK from npm)
  # NOTE: Disabled until CLI and MCP have actual source code
  # To re-enable: remove the `if: false` condition
  build-dependent-packages:
    name: Build & Test ${{ matrix.package }}
    runs-on: ubuntu-latest
    needs: [determine-version, publish-typescript-sdk]
    if: false  # DISABLED: CLI and MCP packages don't have source code yet
    strategy:
      matrix:
        package: [cli, mcp]
      fail-fast: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Update package version
        run: |
          cd packages/${{ matrix.package }}
          npm version ${{ needs.determine-version.outputs.version }} --no-git-tag-version

      - name: Update SDK dependency to use @next version
        run: |
          cd packages/${{ matrix.package }}
          # Update the SDK dependency to the exact version we just published
          npm pkg set dependencies.@memnexus-ai/typescript-sdk=${{ needs.determine-version.outputs.version }}
          echo "‚úÖ Updated SDK dependency to ${{ needs.determine-version.outputs.version }}"

      - name: Install dependencies
        run: |
          cd packages/${{ matrix.package }}
          npm install

      - name: Build package
        run: |
          cd packages/${{ matrix.package }}
          npm run build

      - name: Run tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          cd packages/${{ matrix.package }}
          npm test --passWithNoTests || echo "No tests found, continuing..."

      - name: Check package contents
        run: |
          cd packages/${{ matrix.package }}
          npm pack --dry-run

      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}-built
          path: packages/${{ matrix.package }}/

  # Job 6: Publish CLI and MCP to @next
  # DISABLED: CLI and MCP packages don't have source code yet - enable when ready
  publish-dependent-packages:
    name: Publish CLI & MCP to @next
    if: false  # Disabled until CLI and MCP packages have source code
    runs-on: ubuntu-latest
    needs: [determine-version, build-dependent-packages]
    permissions:
      contents: read
      id-token: write
    outputs:
      version: ${{ needs.determine-version.outputs.version }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          scope: '@memnexus-ai'

      - name: Download CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: cli-built
          path: cli-built/

      - name: Download MCP artifact
        uses: actions/download-artifact@v4
        with:
          name: mcp-built
          path: mcp-built/

      - name: Publish CLI to @next
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
        run: |
          cd cli-built
          npm publish --tag next --access public --provenance --ignore-scripts
          echo "‚úÖ CLI published to @next"

      - name: Publish MCP to @next
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
        run: |
          cd mcp-built
          npm publish --tag next --access public --provenance --ignore-scripts
          echo "‚úÖ MCP Server published to @next"

      - name: Verify all packages published
        run: |
          sleep 5  # Give npm registry time to propagate
          npm view @memnexus-ai/cli@${{ needs.determine-version.outputs.version }} version
          npm view @memnexus-ai/mcp-server@${{ needs.determine-version.outputs.version }} version
          echo "‚úÖ CLI and MCP verified on @next tag"

  # Job 7: Promote all packages to @latest atomically
  promote-to-latest:
    name: Promote to @latest
    runs-on: ubuntu-latest
    # NOTE: When CLI/MCP are enabled, add publish-dependent-packages back to needs
    # NOTE: When PyPI is configured, add publish-python-sdk back to needs
    needs: [publish-typescript-sdk]
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          scope: '@memnexus-ai'

      - name: Un-deprecate and Promote TypeScript SDK to @latest
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          VERSION="${{ needs.publish-typescript-sdk.outputs.version }}"

          # Un-deprecate the package first (in case it was marked deprecated by a previous failed run)
          # An empty string removes the deprecation message
          echo "Removing any deprecation notice from @memnexus-ai/typescript-sdk@${VERSION}..."
          npm deprecate @memnexus-ai/typescript-sdk@${VERSION} "" || echo "No deprecation to remove"

          # Promote to @latest tag
          npm dist-tag add @memnexus-ai/typescript-sdk@${VERSION} latest
          echo "‚úÖ TypeScript SDK promoted to @latest"

      # Note: Python SDK on PyPI doesn't have a similar tag system - latest is determined by version number

      # DISABLED: CLI and MCP packages don't have source code yet - enable when ready
      # - name: Promote CLI to @latest
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      #   run: |
      #     npm dist-tag add @memnexus-ai/cli@${{ needs.publish-dependent-packages.outputs.version }} latest
      #     echo "‚úÖ CLI promoted to @latest"

      # - name: Promote MCP to @latest
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      #   run: |
      #     npm dist-tag add @memnexus-ai/mcp-server@${{ needs.publish-dependent-packages.outputs.version }} latest
      #     echo "‚úÖ MCP Server promoted to @latest"

      - name: Verify promotion
        run: |
          sleep 3
          echo "Verifying @latest tags..."
          npm view @memnexus-ai/typescript-sdk dist-tags
          # npm view @memnexus-ai/cli dist-tags  # Disabled until CLI is ready
          # npm view @memnexus-ai/mcp-server dist-tags  # Disabled until MCP is ready
          echo "‚úÖ TypeScript SDK promoted to @latest"
          echo "‚úÖ Python SDK published to PyPI (latest version)"

  # Job 8: Create Postman Spec and Collection for this version
  # Creates a new API spec in Postman Spec Hub and Collection for each release
  # Requires: POSTMAN_API_KEY and POSTMAN_WORKSPACE_ID secrets
  sync-postman:
    name: Create Postman Spec & Collection
    runs-on: ubuntu-latest
    needs: [determine-version, promote-to-latest]
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create Postman Spec in Spec Hub
        id: create-spec
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
          VERSION: ${{ needs.determine-version.outputs.version }}
        run: |
          # Read the OpenAPI spec content
          SPEC_CONTENT=$(cat specs/openapi.yaml)

          # Create the request payload with spec name, type, and file content
          # Using jq to properly escape the YAML content as JSON string
          PAYLOAD=$(jq -n \
            --arg name "MemNexus Core API v${VERSION}" \
            --arg type "OPENAPI:3.0" \
            --arg path "openapi.yaml" \
            --arg content "$SPEC_CONTENT" \
            '{
              name: $name,
              type: $type,
              files: [
                {
                  path: $path,
                  content: $content
                }
              ]
            }')

          # Create Spec in Postman Spec Hub
          response=$(curl -s -w "\n%{http_code}" -X POST "https://api.getpostman.com/specs?workspaceId=${POSTMAN_WORKSPACE_ID}" \
            -H "X-Api-Key: ${POSTMAN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            SPEC_ID=$(echo "$body" | jq -r '.id')
            echo "spec_id=${SPEC_ID}" >> $GITHUB_OUTPUT
            echo "‚úÖ Created Postman Spec in Spec Hub: ${SPEC_ID}"
            echo "üìé Spec name: MemNexus Core API v${VERSION}"
          else
            echo "‚ùå Failed to create Postman Spec (HTTP $http_code)"
            echo "$body"
            exit 1
          fi

      - name: Generate Collection from Spec
        id: generate-collection
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          SPEC_ID: ${{ steps.create-spec.outputs.spec_id }}
          VERSION: ${{ needs.determine-version.outputs.version }}
        run: |
          # Generate a Postman Collection from the Spec
          response=$(curl -s -w "\n%{http_code}" -X POST "https://api.getpostman.com/specs/${SPEC_ID}/generations/collection" \
            -H "X-Api-Key: ${POSTMAN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"MemNexus Core API v${VERSION}\"
            }")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ] || [ "$http_code" -eq 202 ]; then
            # The response may contain a task ID for async generation or the collection directly
            COLLECTION_ID=$(echo "$body" | jq -r '.collection.id // .id // empty')
            if [ -n "$COLLECTION_ID" ]; then
              echo "collection_id=${COLLECTION_ID}" >> $GITHUB_OUTPUT
              echo "‚úÖ Generated Postman Collection from Spec: ${COLLECTION_ID}"
              echo "üìé View at: https://www.postman.com/collection/${COLLECTION_ID}"
            else
              echo "‚úÖ Collection generation initiated (may be async)"
              echo "$body" | jq .
            fi
          else
            echo "‚ö†Ô∏è Failed to generate Collection from Spec (HTTP $http_code)"
            echo "$body"
            echo "The Spec was created successfully, but Collection generation failed."
            echo "You can generate the Collection manually from Postman Spec Hub."
          fi

  # Job 9: Create GitHub release and update VERSION.yaml
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [determine-version, promote-to-latest, sync-postman]
    if: success()
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Update VERSION.yaml
        run: |
          NEW_VERSION="${{ needs.determine-version.outputs.version }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Update generated.version (API contract version)
          sed -i "/^generated:/,/^  spec_version:/ s/^  version: .*/  version: $NEW_VERSION/" VERSION.yaml

          # Update generated.spec_version
          sed -i "/^generated:/,/^  last_updated:/ s/^  spec_version: .*/  spec_version: $NEW_VERSION/" VERSION.yaml

          # Update generated.last_updated
          sed -i "/^generated:/,/^  packages:/ s/^  last_updated: .*/  last_updated: \"$TIMESTAMP\"/" VERSION.yaml

          echo "‚úÖ VERSION.yaml updated to $NEW_VERSION"

      - name: Update CHANGELOG.md
        run: |
          today=$(date +%Y-%m-%d)
          cat > /tmp/changelog-entry.md << EOF
          ## [${{ needs.determine-version.outputs.version }}] - $today

          ### Changed
          - Platform release ${{ needs.determine-version.outputs.version }}
          - Generated packages (SDK, CLI, MCP Server) updated to ${{ needs.determine-version.outputs.version }}
          - OpenAPI specification synced

          EOF

          # Insert after [Unreleased] section
          sed -i "/## \[Unreleased\]/r /tmp/changelog-entry.md" CHANGELOG.md
          echo "‚úÖ CHANGELOG.md updated"

      - name: Commit version updates
        run: |
          # Improved git handling to prevent race condition conflicts
          # See: https://github.com/memnexus-ai/mx-releases/issues/4

          # Stash any uncommitted changes before pulling
          git stash push -m "temp-release-stash" --include-untracked || true

          # Pull latest changes from main
          git pull --rebase origin main || {
            echo "‚ö†Ô∏è Rebase failed, aborting and retrying..."
            git rebase --abort || true
            git pull origin main --no-rebase || true
          }

          # Restore stashed changes
          git stash pop || true

          git add VERSION.yaml CHANGELOG.md

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No changes to commit (version already updated)"
          else
            git commit -m "chore(release): version ${{ needs.determine-version.outputs.version }}"
          fi

          # Retry push with exponential backoff
          for i in 1 2 3 4 5; do
            if git push origin main; then
              echo "‚úÖ Pushed version updates successfully"
              exit 0
            else
              echo "Push failed, attempt $i/5 - rebasing and retrying..."
              git pull --rebase origin main || {
                echo "‚ö†Ô∏è Rebase failed, aborting..."
                git rebase --abort || true
                git pull origin main --no-rebase || true
              }
              sleep $((i * 2))
            fi
          done

          echo "‚ùå Failed to push after 5 attempts"
          echo "This is likely due to concurrent workflow commits"
          echo "The packages have been published successfully - manual intervention may be needed for VERSION.yaml"
          exit 1

      - name: Create git tags
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"

          # Create tags only if they don't exist
          for tag in "platform-v${VERSION}" "typescript-sdk-v${VERSION}" "python-sdk-v${VERSION}" "cli-v${VERSION}" "mcp-v${VERSION}"; do
            if git rev-parse "$tag" >/dev/null 2>&1; then
              echo "‚è≠Ô∏è Tag $tag already exists, skipping"
            else
              git tag -a "$tag" -m "Release $tag"
              echo "‚úÖ Created tag $tag"
            fi
          done

          git push origin --tags || true
          echo "‚úÖ Git tags pushed"

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.determine-version.outputs.version }}
        run: |
          TAG="platform-v${VERSION}"

          # Check if release already exists
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "‚è≠Ô∏è Release $TAG already exists, skipping"
          else
            gh release create "$TAG" \
              --title "MemNexus Platform v${VERSION}" \
              --notes "## MemNexus Platform v${VERSION}

          Version is automatically managed by mx-core-api based on OpenAPI spec changes.

          ### Published Packages

          All packages share version **${VERSION}**:

          **npm (TypeScript/JavaScript):**
          - **TypeScript SDK**: [\`@memnexus-ai/typescript-sdk@${VERSION}\`](https://www.npmjs.com/package/@memnexus-ai/typescript-sdk)
          - **CLI**: [\`@memnexus-ai/cli@${VERSION}\`](https://www.npmjs.com/package/@memnexus-ai/cli) _(coming soon)_
          - **MCP Server**: [\`@memnexus-ai/mcp-server@${VERSION}\`](https://www.npmjs.com/package/@memnexus-ai/mcp-server) _(coming soon)_

          **PyPI (Python):**
          - **Python SDK**: [\`memnexus-python-sdk@${VERSION}\`](https://pypi.org/project/memnexus-python-sdk/)

          ### Installation

          \`\`\`bash
          # TypeScript/JavaScript SDK
          npm install @memnexus-ai/typescript-sdk@${VERSION}

          # Python SDK
          pip install memnexus-python-sdk==${VERSION}
          \`\`\`

          ### Changes

          See [CHANGELOG.md](https://github.com/memnexus-ai/mx-releases/blob/main/CHANGELOG.md) for detailed changes.

          ### Documentation

          - [OpenAPI Spec](https://github.com/memnexus-ai/mx-releases/blob/main/specs/openapi.yaml)
          - [Postman Collection](https://www.postman.com/memnexus)
          - [TypeScript SDK Documentation](https://github.com/memnexus-ai/mx-releases/tree/main/packages/typescript-sdk)
          - [Python SDK Documentation](https://github.com/memnexus-ai/mx-releases/tree/main/packages/python-sdk)"
            echo "‚úÖ GitHub Release created for $TAG"
          fi

  # Job 10: Rollback on failure - deprecate published packages
  # IMPORTANT: Only rollback if publish or promote steps failed, NOT if later steps
  # like sync-postman or create-release failed (the packages are still functional)
  # See: https://github.com/memnexus-ai/mx-releases/issues/4
  rollback-on-failure:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    # NOTE: When CLI/MCP are enabled, add publish-dependent-packages back to needs
    # NOTE: When PyPI is configured, add publish-python-sdk back to needs
    needs: [determine-version, publish-typescript-sdk, promote-to-latest, sync-postman, create-release]
    # Only deprecate packages if the publish or promote steps actually failed
    # If sync-postman or create-release failed, the packages are still functional
    if: |
      failure() &&
      (needs.publish-typescript-sdk.result == 'failure' ||
       needs.promote-to-latest.result == 'failure')
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          scope: '@memnexus-ai'

      - name: Deprecate TypeScript SDK
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm deprecate @memnexus-ai/typescript-sdk@${{ needs.determine-version.outputs.version }} "Release failed - do not use. Rolled back." || echo "TypeScript SDK not published or already deprecated"

      - name: Deprecate CLI
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm deprecate @memnexus-ai/cli@${{ needs.determine-version.outputs.version }} "Release failed - do not use. Rolled back." || echo "CLI not published or already deprecated"

      - name: Deprecate MCP Server
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm deprecate @memnexus-ai/mcp-server@${{ needs.determine-version.outputs.version }} "Release failed - do not use. Rolled back." || echo "MCP not published or already deprecated"

      # Note: PyPI doesn't support deprecation in the same way - Python SDK would need to be yanked manually if needed

      - name: Report failure
        run: |
          echo "‚ùå Release pipeline failed"
          echo "Version ${{ needs.determine-version.outputs.version }} has been deprecated on npm"
          echo "Note: Python SDK on PyPI may need manual intervention if published"
          echo "Please check the workflow logs for details"
          exit 1
