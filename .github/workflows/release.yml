name: Release Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'specs/openapi.yaml'
      - 'liblab.config.json'
      - '.github/workflows/release.yml'
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Version override (leave empty for auto-detection)'
        required: false
        type: string
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 1: Read version from OpenAPI spec
  # Version is now managed upstream in mx-core-api and embedded in the synced spec
  determine-version:
    name: Read Version from Spec
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install js-yaml
        run: npm install -g js-yaml

      - name: Read version from OpenAPI spec
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version_override }}" ]; then
            # Manual override takes precedence
            VERSION="${{ github.event.inputs.version_override }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "‚úÖ Using manual version override: $VERSION"
          else
            # Extract version from OpenAPI spec info.version field
            VERSION=$(js-yaml specs/openapi.yaml | jq -r '.info.version')

            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              echo "‚ùå ERROR: Could not extract version from OpenAPI spec"
              exit 1
            fi

            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "üì¶ Version from OpenAPI spec: $VERSION"
            echo ""
            echo "‚ÑπÔ∏è  Version is managed upstream by mx-core-api auto-bump workflow"
            echo "‚ÑπÔ∏è  mx-releases simply reads and publishes the version from the spec"
          fi

  # Job 2: Generate SDK using liblab
  generate-sdk:
    name: Generate SDK
    runs-on: ubuntu-latest
    needs: determine-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install liblab CLI
        run: npm install -g liblab

      - name: Verify liblab installation
        run: liblab --version

      - name: Generate SDK with liblab
        env:
          LIBLAB_TOKEN: ${{ secrets.LIBLAB_API_KEY }}
        run: |
          echo "Generating SDK with liblab..."
          liblab build --yes
          echo "‚úÖ SDK generation complete"

      - name: Move generated SDK to packages directory
        run: |
          rm -rf packages/sdk/*
          cp -r output/typescript/* packages/sdk/
          echo "‚úÖ SDK moved to packages/sdk/"

      - name: Update SDK version and fix package metadata
        run: |
          cd packages/sdk
          npm version ${{ needs.determine-version.outputs.version }} --no-git-tag-version
          # Fix package name to use scoped name
          npm pkg set name="@memnexus-ai/sdk"
          # Fix repository URL for npm provenance verification
          npm pkg set repository.type=git
          npm pkg set repository.url="https://github.com/memnexus-ai/mx-releases"
          npm pkg set repository.directory="packages/sdk"
          echo "‚úÖ SDK version updated to ${{ needs.determine-version.outputs.version }}"
          echo "‚úÖ Package name fixed to @memnexus-ai/sdk"
          echo "‚úÖ Repository URL fixed for provenance"

      - name: Upload SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdk-package
          path: packages/sdk/

  # Job 3: Build and test SDK
  build-sdk:
    name: Build & Test SDK
    runs-on: ubuntu-latest
    needs: [determine-version, generate-sdk]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: sdk-package
          path: packages/sdk/

      - name: Install dependencies
        run: |
          cd packages/sdk
          npm ci || npm install

      - name: Build package
        run: |
          cd packages/sdk
          npm run build

      - name: Run tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          cd packages/sdk
          npm test --passWithNoTests || echo "No tests found, continuing..."

      - name: Check package contents
        run: |
          cd packages/sdk
          npm pack --dry-run

      - name: Upload built SDK
        uses: actions/upload-artifact@v4
        with:
          name: sdk-built
          path: packages/sdk/

  # Job 4: Publish SDK to @next (must happen before CLI/MCP can install it)
  publish-sdk:
    name: Publish SDK to @next
    runs-on: ubuntu-latest
    needs: [determine-version, build-sdk]
    permissions:
      contents: read
      id-token: write
    outputs:
      version: ${{ needs.determine-version.outputs.version }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          scope: '@memnexus-ai'

      - name: Download SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: sdk-built
          path: sdk-built/

      - name: Install dependencies
        run: |
          cd sdk-built
          npm ci || npm install

      - name: Check if SDK version already published
        id: check-sdk-published
        run: |
          VERSION=${{ needs.determine-version.outputs.version }}
          if npm view @memnexus-ai/sdk@${VERSION} version 2>/dev/null; then
            echo "SDK version ${VERSION} already published, skipping publish"
            echo "already_published=true" >> $GITHUB_OUTPUT
          else
            echo "SDK version ${VERSION} not found, will publish"
            echo "already_published=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish SDK to @next
        if: steps.check-sdk-published.outputs.already_published != 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
        run: |
          cd sdk-built
          # Use --ignore-scripts to skip prepublishOnly since we already built
          npm publish --tag next --access public --provenance --ignore-scripts
          echo "‚úÖ SDK published to @next"

      - name: Verify SDK published
        run: |
          sleep 5  # Give npm registry time to propagate
          npm view @memnexus-ai/sdk@${{ needs.determine-version.outputs.version }} version
          echo "‚úÖ SDK verified on @next tag"

  # Job 5: Build CLI and MCP (can now install SDK from npm)
  # NOTE: Disabled until CLI and MCP have actual source code
  # To re-enable: remove the `if: false` condition
  build-dependent-packages:
    name: Build & Test ${{ matrix.package }}
    runs-on: ubuntu-latest
    needs: [determine-version, publish-sdk]
    if: false  # DISABLED: CLI and MCP packages don't have source code yet
    strategy:
      matrix:
        package: [cli, mcp]
      fail-fast: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Update package version
        run: |
          cd packages/${{ matrix.package }}
          npm version ${{ needs.determine-version.outputs.version }} --no-git-tag-version

      - name: Update SDK dependency to use @next version
        run: |
          cd packages/${{ matrix.package }}
          # Update the SDK dependency to the exact version we just published
          npm pkg set dependencies.@memnexus-ai/sdk=${{ needs.determine-version.outputs.version }}
          echo "‚úÖ Updated SDK dependency to ${{ needs.determine-version.outputs.version }}"

      - name: Install dependencies
        run: |
          cd packages/${{ matrix.package }}
          npm install

      - name: Build package
        run: |
          cd packages/${{ matrix.package }}
          npm run build

      - name: Run tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          cd packages/${{ matrix.package }}
          npm test --passWithNoTests || echo "No tests found, continuing..."

      - name: Check package contents
        run: |
          cd packages/${{ matrix.package }}
          npm pack --dry-run

      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}-built
          path: packages/${{ matrix.package }}/

  # Job 6: Publish CLI and MCP to @next
  # DISABLED: CLI and MCP packages don't have source code yet - enable when ready
  publish-dependent-packages:
    name: Publish CLI & MCP to @next
    if: false  # Disabled until CLI and MCP packages have source code
    runs-on: ubuntu-latest
    needs: [determine-version, build-dependent-packages]
    permissions:
      contents: read
      id-token: write
    outputs:
      version: ${{ needs.determine-version.outputs.version }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          scope: '@memnexus-ai'

      - name: Download CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: cli-built
          path: cli-built/

      - name: Download MCP artifact
        uses: actions/download-artifact@v4
        with:
          name: mcp-built
          path: mcp-built/

      - name: Publish CLI to @next
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
        run: |
          cd cli-built
          npm publish --tag next --access public --provenance --ignore-scripts
          echo "‚úÖ CLI published to @next"

      - name: Publish MCP to @next
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
        run: |
          cd mcp-built
          npm publish --tag next --access public --provenance --ignore-scripts
          echo "‚úÖ MCP Server published to @next"

      - name: Verify all packages published
        run: |
          sleep 5  # Give npm registry time to propagate
          npm view @memnexus-ai/cli@${{ needs.determine-version.outputs.version }} version
          npm view @memnexus-ai/mcp-server@${{ needs.determine-version.outputs.version }} version
          echo "‚úÖ CLI and MCP verified on @next tag"

  # Job 7: Promote all packages to @latest atomically
  promote-to-latest:
    name: Promote to @latest
    runs-on: ubuntu-latest
    # NOTE: When CLI/MCP are enabled, add publish-dependent-packages back to needs
    needs: [publish-sdk]
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          scope: '@memnexus-ai'

      - name: Promote SDK to @latest
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm dist-tag add @memnexus-ai/sdk@${{ needs.publish-sdk.outputs.version }} latest
          echo "‚úÖ SDK promoted to @latest"

      # DISABLED: CLI and MCP packages don't have source code yet - enable when ready
      # - name: Promote CLI to @latest
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      #   run: |
      #     npm dist-tag add @memnexus-ai/cli@${{ needs.publish-dependent-packages.outputs.version }} latest
      #     echo "‚úÖ CLI promoted to @latest"

      # - name: Promote MCP to @latest
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      #   run: |
      #     npm dist-tag add @memnexus-ai/mcp-server@${{ needs.publish-dependent-packages.outputs.version }} latest
      #     echo "‚úÖ MCP Server promoted to @latest"

      - name: Verify promotion
        run: |
          sleep 3
          echo "Verifying @latest tags..."
          npm view @memnexus-ai/sdk dist-tags
          # npm view @memnexus-ai/cli dist-tags  # Disabled until CLI is ready
          # npm view @memnexus-ai/mcp-server dist-tags  # Disabled until MCP is ready
          echo "‚úÖ SDK promoted to @latest"

  # Job 8: Create Postman Spec and Collection for this version
  # Creates a new API spec in Postman Spec Hub and Collection for each release
  # Requires: POSTMAN_API_KEY and POSTMAN_WORKSPACE_ID secrets
  sync-postman:
    name: Create Postman Spec & Collection
    runs-on: ubuntu-latest
    needs: [determine-version, promote-to-latest]
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create Postman Spec in Spec Hub
        id: create-spec
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
          VERSION: ${{ needs.determine-version.outputs.version }}
        run: |
          # Read the OpenAPI spec content
          SPEC_CONTENT=$(cat specs/openapi.yaml)

          # Create the request payload with spec name, type, and file content
          # Using jq to properly escape the YAML content as JSON string
          PAYLOAD=$(jq -n \
            --arg name "MemNexus Core API v${VERSION}" \
            --arg type "OPENAPI:3.0" \
            --arg path "openapi.yaml" \
            --arg content "$SPEC_CONTENT" \
            '{
              name: $name,
              type: $type,
              files: [
                {
                  path: $path,
                  content: $content
                }
              ]
            }')

          # Create Spec in Postman Spec Hub
          response=$(curl -s -w "\n%{http_code}" -X POST "https://api.getpostman.com/specs?workspaceId=${POSTMAN_WORKSPACE_ID}" \
            -H "X-Api-Key: ${POSTMAN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            SPEC_ID=$(echo "$body" | jq -r '.id')
            echo "spec_id=${SPEC_ID}" >> $GITHUB_OUTPUT
            echo "‚úÖ Created Postman Spec in Spec Hub: ${SPEC_ID}"
            echo "üìé Spec name: MemNexus Core API v${VERSION}"
          else
            echo "‚ùå Failed to create Postman Spec (HTTP $http_code)"
            echo "$body"
            exit 1
          fi

      - name: Generate Collection from Spec
        id: generate-collection
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          SPEC_ID: ${{ steps.create-spec.outputs.spec_id }}
          VERSION: ${{ needs.determine-version.outputs.version }}
        run: |
          # Generate a Postman Collection from the Spec
          response=$(curl -s -w "\n%{http_code}" -X POST "https://api.getpostman.com/specs/${SPEC_ID}/generations/collection" \
            -H "X-Api-Key: ${POSTMAN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"MemNexus Core API v${VERSION}\"
            }")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ] || [ "$http_code" -eq 202 ]; then
            # The response may contain a task ID for async generation or the collection directly
            COLLECTION_ID=$(echo "$body" | jq -r '.collection.id // .id // empty')
            if [ -n "$COLLECTION_ID" ]; then
              echo "collection_id=${COLLECTION_ID}" >> $GITHUB_OUTPUT
              echo "‚úÖ Generated Postman Collection from Spec: ${COLLECTION_ID}"
              echo "üìé View at: https://www.postman.com/collection/${COLLECTION_ID}"
            else
              echo "‚úÖ Collection generation initiated (may be async)"
              echo "$body" | jq .
            fi
          else
            echo "‚ö†Ô∏è Failed to generate Collection from Spec (HTTP $http_code)"
            echo "$body"
            echo "The Spec was created successfully, but Collection generation failed."
            echo "You can generate the Collection manually from Postman Spec Hub."
          fi

  # Job 9: Create GitHub release and update VERSION.yaml
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [determine-version, promote-to-latest, sync-postman]
    if: success()
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Update VERSION.yaml
        run: |
          NEW_VERSION="${{ needs.determine-version.outputs.version }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Update generated.version (API contract version)
          sed -i "/^generated:/,/^  spec_version:/ s/^  version: .*/  version: $NEW_VERSION/" VERSION.yaml

          # Update generated.spec_version
          sed -i "/^generated:/,/^  last_updated:/ s/^  spec_version: .*/  spec_version: $NEW_VERSION/" VERSION.yaml

          # Update generated.last_updated
          sed -i "/^generated:/,/^  packages:/ s/^  last_updated: .*/  last_updated: \"$TIMESTAMP\"/" VERSION.yaml

          echo "‚úÖ VERSION.yaml updated to $NEW_VERSION"

      - name: Update CHANGELOG.md
        run: |
          today=$(date +%Y-%m-%d)
          cat > /tmp/changelog-entry.md << EOF
          ## [${{ needs.determine-version.outputs.version }}] - $today

          ### Changed
          - Platform release ${{ needs.determine-version.outputs.version }}
          - Generated packages (SDK, CLI, MCP Server) updated to ${{ needs.determine-version.outputs.version }}
          - OpenAPI specification synced

          EOF

          # Insert after [Unreleased] section
          sed -i "/## \[Unreleased\]/r /tmp/changelog-entry.md" CHANGELOG.md
          echo "‚úÖ CHANGELOG.md updated"

      - name: Commit version updates
        run: |
          git add VERSION.yaml CHANGELOG.md
          git commit -m "chore(release): version ${{ needs.determine-version.outputs.version }}"
          git push origin master

      - name: Create git tags
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"

          # Create tags only if they don't exist
          for tag in "platform-v${VERSION}" "sdk-v${VERSION}" "cli-v${VERSION}" "mcp-v${VERSION}"; do
            if git rev-parse "$tag" >/dev/null 2>&1; then
              echo "‚è≠Ô∏è Tag $tag already exists, skipping"
            else
              git tag -a "$tag" -m "Release $tag"
              echo "‚úÖ Created tag $tag"
            fi
          done

          git push origin --tags || true
          echo "‚úÖ Git tags pushed"

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.determine-version.outputs.version }}
        run: |
          TAG="platform-v${VERSION}"

          # Check if release already exists
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "‚è≠Ô∏è Release $TAG already exists, skipping"
          else
            gh release create "$TAG" \
              --title "MemNexus Platform v${VERSION}" \
              --notes "## MemNexus Platform v${VERSION}

          Version is automatically managed by mx-core-api based on OpenAPI spec changes.

          ### Published Packages

          All packages share version **${VERSION}** and are published to npm:

          - **SDK**: [\`@memnexus-ai/sdk@${VERSION}\`](https://www.npmjs.com/package/@memnexus-ai/sdk)
          - **CLI**: [\`@memnexus-ai/cli@${VERSION}\`](https://www.npmjs.com/package/@memnexus-ai/cli) _(coming soon)_
          - **MCP Server**: [\`@memnexus-ai/mcp-server@${VERSION}\`](https://www.npmjs.com/package/@memnexus-ai/mcp-server) _(coming soon)_

          ### Installation

          \`\`\`bash
          # SDK
          npm install @memnexus-ai/sdk@${VERSION}
          \`\`\`

          ### Changes

          See [CHANGELOG.md](https://github.com/memnexus-ai/mx-releases/blob/main/CHANGELOG.md) for detailed changes.

          ### Documentation

          - [OpenAPI Spec](https://github.com/memnexus-ai/mx-releases/blob/main/specs/openapi.yaml)
          - [Postman Collection](https://www.postman.com/memnexus)
          - [SDK Documentation](https://github.com/memnexus-ai/mx-releases/tree/main/packages/sdk)"
            echo "‚úÖ GitHub Release created for $TAG"
          fi

  # Job 10: Rollback on failure - deprecate published packages
  rollback-on-failure:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    # NOTE: When CLI/MCP are enabled, add publish-dependent-packages back to needs
    needs: [determine-version, publish-sdk, promote-to-latest, sync-postman, create-release]
    if: failure()
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          scope: '@memnexus-ai'

      - name: Deprecate SDK
        run: |
          npm deprecate @memnexus-ai/sdk@${{ needs.determine-version.outputs.version }} "Release failed - do not use. Rolled back." || echo "SDK not published or already deprecated"

      - name: Deprecate CLI
        run: |
          npm deprecate @memnexus-ai/cli@${{ needs.determine-version.outputs.version }} "Release failed - do not use. Rolled back." || echo "CLI not published or already deprecated"

      - name: Deprecate MCP Server
        run: |
          npm deprecate @memnexus-ai/mcp-server@${{ needs.determine-version.outputs.version }} "Release failed - do not use. Rolled back." || echo "MCP not published or already deprecated"

      - name: Report failure
        run: |
          echo "‚ùå Release pipeline failed"
          echo "Version ${{ needs.determine-version.outputs.version }} has been deprecated"
          echo "Please check the workflow logs for details"
          exit 1
