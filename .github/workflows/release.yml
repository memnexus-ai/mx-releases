name: Release Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'specs/openapi.yaml'
      - 'liblab.config.json'
      - '.github/workflows/release.yml'
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Version override (leave empty for auto-detection)'
        required: false
        type: string
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 1: Read version from OpenAPI spec
  # Version is now managed upstream in mx-core-api and embedded in the synced spec
  determine-version:
    name: Read Version from Spec
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install js-yaml
        run: npm install -g js-yaml

      - name: Read version from OpenAPI spec
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version_override }}" ]; then
            # Manual override takes precedence
            VERSION="${{ github.event.inputs.version_override }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… Using manual version override: $VERSION"
          else
            # Extract version from OpenAPI spec info.version field
            VERSION=$(js-yaml specs/openapi.yaml | jq -r '.info.version')

            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              echo "âŒ ERROR: Could not extract version from OpenAPI spec"
              exit 1
            fi

            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Version from OpenAPI spec: $VERSION"
            echo ""
            echo "â„¹ï¸  Version is managed upstream by mx-core-api auto-bump workflow"
            echo "â„¹ï¸  mx-releases simply reads and publishes the version from the spec"
          fi

  # Job 2: Generate SDK using liblab
  generate-sdk:
    name: Generate SDK
    runs-on: ubuntu-latest
    needs: determine-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install liblab CLI
        run: npm install -g liblab

      - name: Verify liblab installation
        run: liblab --version

      - name: Generate SDK with liblab
        env:
          LIBLAB_TOKEN: ${{ secrets.LIBLAB_API_KEY }}
        run: |
          echo "Generating SDK with liblab..."
          liblab build --yes
          echo "âœ… SDK generation complete"

      - name: Move generated SDK to packages directory
        run: |
          rm -rf packages/sdk/*
          cp -r output/typescript/* packages/sdk/
          echo "âœ… SDK moved to packages/sdk/"

      - name: Update SDK version and fix repository URL
        run: |
          cd packages/sdk
          npm version ${{ needs.determine-version.outputs.version }} --no-git-tag-version
          # Fix repository URL for npm provenance verification
          npm pkg set repository.type=git
          npm pkg set repository.url="https://github.com/memnexus-ai/mx-releases"
          npm pkg set repository.directory="packages/sdk"
          echo "âœ… SDK version updated to ${{ needs.determine-version.outputs.version }}"
          echo "âœ… Repository URL fixed for provenance"

      - name: Upload SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdk-package
          path: packages/sdk/

  # Job 3: Build and test SDK
  build-sdk:
    name: Build & Test SDK
    runs-on: ubuntu-latest
    needs: [determine-version, generate-sdk]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: sdk-package
          path: packages/sdk/

      - name: Install dependencies
        run: |
          cd packages/sdk
          npm ci || npm install

      - name: Build package
        run: |
          cd packages/sdk
          npm run build

      - name: Run tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          cd packages/sdk
          npm test --passWithNoTests || echo "No tests found, continuing..."

      - name: Check package contents
        run: |
          cd packages/sdk
          npm pack --dry-run

      - name: Upload built SDK
        uses: actions/upload-artifact@v4
        with:
          name: sdk-built
          path: packages/sdk/

  # Job 4: Publish SDK to @next (must happen before CLI/MCP can install it)
  publish-sdk:
    name: Publish SDK to @next
    runs-on: ubuntu-latest
    needs: [determine-version, build-sdk]
    permissions:
      contents: read
      id-token: write
    outputs:
      version: ${{ needs.determine-version.outputs.version }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          scope: '@memnexus-ai'

      - name: Download SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: sdk-built
          path: sdk-built/

      - name: Install dependencies
        run: |
          cd sdk-built
          npm ci || npm install

      - name: Publish SDK to @next
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
        run: |
          cd sdk-built
          # Use --ignore-scripts to skip prepublishOnly since we already built
          npm publish --tag next --access public --provenance --ignore-scripts
          echo "âœ… SDK published to @next"

      - name: Verify SDK published
        run: |
          sleep 5  # Give npm registry time to propagate
          npm view @memnexus-ai/sdk@${{ needs.determine-version.outputs.version }} version
          echo "âœ… SDK verified on @next tag"

  # Job 5: Build CLI and MCP (can now install SDK from npm)
  build-dependent-packages:
    name: Build & Test ${{ matrix.package }}
    runs-on: ubuntu-latest
    needs: [determine-version, publish-sdk]
    strategy:
      matrix:
        package: [cli, mcp]
      fail-fast: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Update package version
        run: |
          cd packages/${{ matrix.package }}
          npm version ${{ needs.determine-version.outputs.version }} --no-git-tag-version

      - name: Update SDK dependency to use @next version
        run: |
          cd packages/${{ matrix.package }}
          # Update the SDK dependency to the exact version we just published
          npm pkg set dependencies.@memnexus-ai/sdk=${{ needs.determine-version.outputs.version }}
          echo "âœ… Updated SDK dependency to ${{ needs.determine-version.outputs.version }}"

      - name: Install dependencies
        run: |
          cd packages/${{ matrix.package }}
          npm install

      - name: Build package
        run: |
          cd packages/${{ matrix.package }}
          npm run build

      - name: Run tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          cd packages/${{ matrix.package }}
          npm test --passWithNoTests || echo "No tests found, continuing..."

      - name: Check package contents
        run: |
          cd packages/${{ matrix.package }}
          npm pack --dry-run

      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}-built
          path: packages/${{ matrix.package }}/

  # Job 6: Publish CLI and MCP to @next
  publish-dependent-packages:
    name: Publish CLI & MCP to @next
    runs-on: ubuntu-latest
    needs: [determine-version, build-dependent-packages]
    permissions:
      contents: read
      id-token: write
    outputs:
      version: ${{ needs.determine-version.outputs.version }}
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          scope: '@memnexus-ai'

      - name: Download CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: cli-built
          path: cli-built/

      - name: Download MCP artifact
        uses: actions/download-artifact@v4
        with:
          name: mcp-built
          path: mcp-built/

      - name: Publish CLI to @next
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
        run: |
          cd cli-built
          npm publish --tag next --access public --provenance --ignore-scripts
          echo "âœ… CLI published to @next"

      - name: Publish MCP to @next
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
        run: |
          cd mcp-built
          npm publish --tag next --access public --provenance --ignore-scripts
          echo "âœ… MCP Server published to @next"

      - name: Verify all packages published
        run: |
          sleep 5  # Give npm registry time to propagate
          npm view @memnexus-ai/cli@${{ needs.determine-version.outputs.version }} version
          npm view @memnexus-ai/mcp-server@${{ needs.determine-version.outputs.version }} version
          echo "âœ… CLI and MCP verified on @next tag"

  # Job 7: Promote all packages to @latest atomically
  promote-to-latest:
    name: Promote to @latest
    runs-on: ubuntu-latest
    needs: [publish-sdk, publish-dependent-packages]
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          scope: '@memnexus-ai'

      - name: Promote SDK to @latest
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm dist-tag add @memnexus-ai/sdk@${{ needs.publish-sdk.outputs.version }} latest
          echo "âœ… SDK promoted to @latest"

      - name: Promote CLI to @latest
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm dist-tag add @memnexus-ai/cli@${{ needs.publish-dependent-packages.outputs.version }} latest
          echo "âœ… CLI promoted to @latest"

      - name: Promote MCP to @latest
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm dist-tag add @memnexus-ai/mcp-server@${{ needs.publish-dependent-packages.outputs.version }} latest
          echo "âœ… MCP Server promoted to @latest"

      - name: Verify promotion
        run: |
          sleep 3
          echo "Verifying @latest tags..."
          npm view @memnexus-ai/sdk dist-tags
          npm view @memnexus-ai/cli dist-tags
          npm view @memnexus-ai/mcp-server dist-tags
          echo "âœ… All packages promoted to @latest"

  # Job 8: Sync OpenAPI spec to Postman Spec Hub
  sync-postman-spec:
    name: Sync Postman Spec
    runs-on: ubuntu-latest
    needs: promote-to-latest
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync OpenAPI to Postman Spec Hub
        uses: postmanlabs/push-openapi-to-postman-spec@v1
        with:
          path-to-definition: specs/openapi.yaml
          postman-api-key: ${{ secrets.POSTMAN_API_KEY }}
          spec-id: ${{ secrets.POSTMAN_SPEC_ID }}
          api-path-to-file-name: index.yaml

      - name: Verify spec sync
        run: echo "âœ… OpenAPI spec synced to Postman Spec Hub"

  # Job 9: Update Postman Collection
  sync-postman-collection:
    name: Sync Postman Collection
    runs-on: ubuntu-latest
    needs: promote-to-latest
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install openapi-to-postman
        run: npm install -g openapi-to-postmanv2

      - name: Convert OpenAPI to Postman Collection
        run: |
          openapi2postmanv2 -s specs/openapi.yaml -o postman-collection.json -p
          echo "âœ… Converted OpenAPI to Postman Collection"

      - name: Update Postman Collection
        run: |
          jq -c '{collection: .}' postman-collection.json > /tmp/postman-wrapped.json

          response=$(curl -X PUT "https://api.getpostman.com/collections/${{ secrets.POSTMAN_COLLECTION_ID }}" \
            -H "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d @/tmp/postman-wrapped.json \
            -w "\n%{http_code}" \
            -s)

          http_code=$(echo "$response" | tail -n1)

          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Postman Collection updated successfully"
          else
            echo "âŒ Failed to update Postman Collection (HTTP $http_code)"
            exit 1
          fi

  # Job 10: Create GitHub release and update VERSION.yaml
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [determine-version, promote-to-latest, sync-postman-spec, sync-postman-collection]
    if: success()
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Update VERSION.yaml
        run: |
          NEW_VERSION="${{ needs.determine-version.outputs.version }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Update generated.version (API contract version)
          sed -i "/^generated:/,/^  spec_version:/ s/^  version: .*/  version: $NEW_VERSION/" VERSION.yaml

          # Update generated.spec_version
          sed -i "/^generated:/,/^  last_updated:/ s/^  spec_version: .*/  spec_version: $NEW_VERSION/" VERSION.yaml

          # Update generated.last_updated
          sed -i "/^generated:/,/^  packages:/ s/^  last_updated: .*/  last_updated: \"$TIMESTAMP\"/" VERSION.yaml

          echo "âœ… VERSION.yaml updated to $NEW_VERSION"

      - name: Update CHANGELOG.md
        run: |
          today=$(date +%Y-%m-%d)
          cat > /tmp/changelog-entry.md << EOF
          ## [${{ needs.determine-version.outputs.version }}] - $today

          ### Changed
          - Platform release ${{ needs.determine-version.outputs.version }}
          - Generated packages (SDK, CLI, MCP Server) updated to ${{ needs.determine-version.outputs.version }}
          - OpenAPI specification synced

          EOF

          # Insert after [Unreleased] section
          sed -i "/## \[Unreleased\]/r /tmp/changelog-entry.md" CHANGELOG.md
          echo "âœ… CHANGELOG.md updated"

      - name: Commit version updates
        run: |
          git add VERSION.yaml CHANGELOG.md
          git commit -m "chore(release): version ${{ needs.determine-version.outputs.version }}"
          git push origin main

      - name: Create git tags
        run: |
          git tag -a "platform-v${{ needs.determine-version.outputs.version }}" -m "Platform release v${{ needs.determine-version.outputs.version }}"
          git tag -a "sdk-v${{ needs.determine-version.outputs.version }}" -m "SDK release v${{ needs.determine-version.outputs.version }}"
          git tag -a "cli-v${{ needs.determine-version.outputs.version }}" -m "CLI release v${{ needs.determine-version.outputs.version }}"
          git tag -a "mcp-v${{ needs.determine-version.outputs.version }}" -m "MCP Server release v${{ needs.determine-version.outputs.version }}"
          git push origin --tags
          echo "âœ… Git tags created and pushed"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: platform-v${{ needs.determine-version.outputs.version }}
          release_name: 'MemNexus Platform v${{ needs.determine-version.outputs.version }}'
          body: |
            ## MemNexus Platform v${{ needs.determine-version.outputs.version }}

            Version is automatically managed by mx-core-api based on OpenAPI spec changes.

            ### Published Packages

            All packages share version **${{ needs.determine-version.outputs.version }}** and are published to npm:

            - **SDK**: [`@memnexus-ai/sdk@${{ needs.determine-version.outputs.version }}`](https://www.npmjs.com/package/@memnexus-ai/sdk)
            - **CLI**: [`@memnexus-ai/cli@${{ needs.determine-version.outputs.version }}`](https://www.npmjs.com/package/@memnexus-ai/cli)
            - **MCP Server**: [`@memnexus-ai/mcp-server@${{ needs.determine-version.outputs.version }}`](https://www.npmjs.com/package/@memnexus-ai/mcp-server)

            ### Installation

            ```bash
            # SDK
            npm install @memnexus-ai/sdk@${{ needs.determine-version.outputs.version }}

            # CLI
            npm install -g @memnexus-ai/cli@${{ needs.determine-version.outputs.version }}

            # MCP Server
            npm install @memnexus-ai/mcp-server@${{ needs.determine-version.outputs.version }}
            ```

            ### Changes

            See [CHANGELOG.md](https://github.com/memnexus-ai/mx-releases/blob/main/CHANGELOG.md) for detailed changes.

            ### Documentation

            - [OpenAPI Spec](https://github.com/memnexus-ai/mx-releases/blob/main/specs/openapi.yaml)
            - [Postman Collection](https://www.postman.com/memnexus)
            - [SDK Documentation](https://github.com/memnexus-ai/mx-releases/tree/main/packages/sdk)
          draft: false
          prerelease: false

  # Job 11: Rollback on failure - deprecate published packages
  rollback-on-failure:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [determine-version, publish-sdk, publish-dependent-packages, promote-to-latest, sync-postman-spec, sync-postman-collection, create-release]
    if: failure()
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          scope: '@memnexus-ai'

      - name: Deprecate SDK
        run: |
          npm deprecate @memnexus-ai/sdk@${{ needs.determine-version.outputs.version }} "Release failed - do not use. Rolled back." || echo "SDK not published or already deprecated"

      - name: Deprecate CLI
        run: |
          npm deprecate @memnexus-ai/cli@${{ needs.determine-version.outputs.version }} "Release failed - do not use. Rolled back." || echo "CLI not published or already deprecated"

      - name: Deprecate MCP Server
        run: |
          npm deprecate @memnexus-ai/mcp-server@${{ needs.determine-version.outputs.version }} "Release failed - do not use. Rolled back." || echo "MCP not published or already deprecated"

      - name: Report failure
        run: |
          echo "âŒ Release pipeline failed"
          echo "Version ${{ needs.determine-version.outputs.version }} has been deprecated"
          echo "Please check the workflow logs for details"
          exit 1
